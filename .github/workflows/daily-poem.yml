name: Daily Poem Update

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTC 0ç‚¹æ‰§è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-poem:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…³é”®ï¼šæ·»åŠ å†™å…¥æƒé™
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true  # ä¿æŒå‡­è¯

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch poem
        id: fetch_poem
        run: |
          poem=$(curl -s "https://v1.jinrishici.com/all.json")
          # å¢å¼ºå®¹é”™ï¼šAPIå¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å€¼
          content=$(echo "$poem" | jq -r '.content // "æ˜¥é£å¾—æ„é©¬è¹„ç–¾ï¼Œä¸€æ—¥çœ‹å°½é•¿å®‰èŠ±"')
          author=$(echo "$poem" | jq -r '.author // "å­ŸéƒŠ"')
          origin=$(echo "$poem" | jq -r '.origin // "ç™»ç§‘å"')

          # å¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼ˆé¿å…sedæ›¿æ¢å¤±è´¥ï¼‰
          content=$(echo "$content" | sed 's/[\/&]/\\&/g')
          author=$(echo "$author" | sed 's/[\/&]/\\&/g')
          origin=$(echo "$origin" | sed 's/[\/&]/\\&/g')

          echo "POEM_CONTENT=$content" >> $GITHUB_ENV
          echo "POEM_AUTHOR=$author" >> $GITHUB_ENV
          echo "POEM_ORIGIN=$origin" >> $GITHUB_ENV

      - name: Update README
        run: |
          # æ›¿æ¢å ä½ç¬¦ï¼ˆç¡®ä¿ä¸READMEä¸­çš„æ ¼å¼å®Œå…¨ä¸€è‡´ï¼‰
          sed -i "s/Hello ğŸ‘‹ I'm Geekstrange/${{ env.POEM_CONTENT }}/g" README.md
          sed -i "s/Some days you bloom, some days you grow roots. Both matter./â€”â€” ${{ env.POEM_AUTHOR }}ã€Š${{ env.POEM_ORIGIN }}ã€‹/g" README.md

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update daily poem"
          push_options: --force
