name: Daily Poem Update

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC 0点执行
  workflow_dispatch:  # 允许手动触发

jobs:
  update-poem:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 关键：添加写入权限
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true  # 保持凭证

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch poem
        id: fetch_poem
        run: |
          poem=$(curl -s "https://v1.jinrishici.com/all.json")
          # 增强容错：API失败时使用默认值
          content=$(echo "$poem" | jq -r '.content // "春风得意马蹄疾，一日看尽长安花"')
          author=$(echo "$poem" | jq -r '.author // "孟郊"')
          origin=$(echo "$poem" | jq -r '.origin // "登科后"')

          # 处理特殊字符（避免sed替换失败）
          content=$(echo "$content" | sed 's/[\/&]/\\&/g')
          author=$(echo "$author" | sed 's/[\/&]/\\&/g')
          origin=$(echo "$origin" | sed 's/[\/&]/\\&/g')

          echo "POEM_CONTENT=$content" >> $GITHUB_ENV
          echo "POEM_AUTHOR=$author" >> $GITHUB_ENV
          echo "POEM_ORIGIN=$origin" >> $GITHUB_ENV

      - name: Update README
        run: |
          # 替换占位符（确保与README中的格式完全一致）
          sed -i "s/Hello 👋 I'm Geekstrange/${{ env.POEM_CONTENT }}/g" README.md
          sed -i "s/Some days you bloom, some days you grow roots. Both matter./—— ${{ env.POEM_AUTHOR }}《${{ env.POEM_ORIGIN }}》/g" README.md

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update daily poem"
          push_options: --force
