name: Daily Poem Update

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTC 0ç‚¹æ‰§è¡Œ(åŒ—äº¬æ—¶é—´8ç‚¹)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-poem:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # èµ‹äºˆå†™å…¥æƒé™
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Determine content based on day
        id: content_generator
        run: |
          # è·å–å½“å‰æ˜ŸæœŸå‡ (1=å‘¨ä¸€ ... 6=å‘¨å…­ 7=å‘¨æ—¥)
          day_of_week=$(date +%u)
          echo "å½“å‰æ˜ŸæœŸå‡ : $day_of_week"

          # å‘¨æœ«(å‘¨å…­=6 å‘¨æ—¥=7)ä½¿ç”¨åŸå¥
          if [ $day_of_week -ge 6 ]; then
            title="Hello ğŸ‘‹ I'm Geekstrange"
            subtitle="Some days you bloom, some days you grow roots. Both matter."
          else
            # å·¥ä½œæ—¥è°ƒç”¨è¯—è¯API
            poem=$(curl -s "https://v1.jinrishici.com/all.json")
            title=$(echo "$poem" | jq -r '.content // "é•¿é£ç ´æµªä¼šæœ‰æ—¶ï¼Œç›´æŒ‚äº‘å¸†æµæ²§æµ·"')
            subtitle="â€”â€” $(echo "$poem" | jq -r '.author // "æç™½"')ã€Š$(echo "$poem" | jq -r '.origin // "è¡Œè·¯éš¾"')ã€‹"
          fi

          # å¤„ç†ç‰¹æ®Šå­—ç¬¦(é¿å…sedæ›¿æ¢å¤±è´¥)
          title=$(echo "$title" | sed 's/[\/&]/\\&/g')
          subtitle=$(echo "$subtitle" | sed 's/[\/&]/\\&/g')

          echo "TITLE=$title" >> $GITHUB_ENV
          echo "SUBTITLE=$subtitle" >> $GITHUB_ENV

      - name: Update README
        run: |
          # æ›¿æ¢æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
          sed -i "s/<h1 align=\"center\">.*<\/h1>/<h1 align=\"center\">${{ env.TITLE }}<\/h1>/g" README.md
          sed -i "s/<h3 align=\"center\">.*<\/h3>/<h3 align=\"center\">${{ env.SUBTITLE }}<\/h3>/g" README.md

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update daily content"
          push_options: --force
